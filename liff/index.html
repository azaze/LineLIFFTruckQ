<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0,viewport-fit=cover">
  <title>LCB1 Truck Q</title>
  <link rel="stylesheet" href="css/style.css" media="all">
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/notie/4.3.1/notie.css">
 
  <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css"> -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>


  <link href="css/jquery.mobile-1.4.4.min.css" rel="stylesheet" />
  <link href="https://cdn.jtsage.com/datebox/1.4.4/jqm-datebox-1.4.4.min.css" rel="stylesheet" />
<!-- NOTE: Script load order is significant! -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.js"></script>
<script src="https://code.jquery.com/mobile/1.4.4/jquery.mobile-1.4.4.min.js"></script>
<!-- <script src="https://cdn.jtsage.com/datebox/1.4.4/jqm-datebox-1.4.4.core.min.js"></script> -->
<script src="js/jqm-datebox-1.4.4.core.min.js"></script>
<script src="https://cdn.jtsage.com/datebox/1.4.4/jqm-datebox-1.4.4.mode.flipbox.min.js"></script>
<script src="js/notie.js"></script>
<script src="js/core.js"></script>
<style>
  
</style>
</head>
<body>
<div id="step1" class="container">
  <heading>
  <div class="heading"><table><tbody><tr><td id="line1"></td><td id="line2">Welcome to LCB1 and  LCMT</td><td id="line3"></td></tr></tbody></table><div class="heading-line"></div></div>
   <div class="row header">
    <div class="col-sm-12"><img id="pictureUrl" style="height: 100px;width: 100px;"></div>
  </div></heading> 
  <div class="row" style="display: none;">
    <div class="col-sm-12"><p id="userId"></p></div>
  </div> 
  <div class="row">
    <div class="col-sm-12"><p id="displayName"></p></div>
  </div> 
  <h3 class="form-control" style="background-color: blueviolet;color: #fff;">ข้อมูลการของคิว</h3>
  <div class="row">
    <div class="col-sm-12">
      <label>ท่าเรือ</label>
      <select id="ddlTerminal" class="form-control">
        <option selected="" value="--">--</option>
        <option value="A0">A0</option>
        <option value="B1">B1</option>
    </select>
    </div>
  </div>   
  <div class="row">
    <div class="col-sm-12">
      <label>กิจกรรม</label>
      <select id="ddlToPic" class="form-control">
      <option selected="" value="--">--</option>
      <option value="ส่งตู้(หนัก)">ส่งตู้(หนัก)</option>
      <option value="รับตู้(หนัก)">รับตู้(หนัก)</option>
       
    </select>
    </div>
  </div> 
  <div class="row">
    <div class="col-sm-12">
      <label>วันที่จอง</label>
      <input type="text" id="txtDate" data-role="datebox" data-options='{&quot;mode&quot;:&quot;flipbox&quot;}' data-date-format="dd/mm/yyyy" />
    </div>
  </div> 
   
  <div class="row">
    <div class="col-sm-12">
      <br/>
      <button id="btnMsg" onclick="step1()" class="btn btn-primary">ถัดไป</button>
    </div>
  </div> 
</div>
<div id="step2" class="container">
  <div class="col-sm-12">
  <div class="row">
      <div class="col-12">
        <div class="dvTop"> 
        <h3 class="form-control" style="background-color: blueviolet;color: #fff;">ระบุข้อมูล</h3>
      </div>
       
        </div>
      </div>
      <div class="row">
        <div class="col-12">
         
        <div id="checkboxes" style="overflow-y: scroll;margin-bottom: 20%;margin-top: 10%;">
             
          </div>
           
        </div></div>
  </div> 
  <br/>
  <div class="dvButtom">
 <div class="row btnSaveStep2">
    <div class="col-12">
      <div class="col-sm-12">
      <button id="btnStep2" onclick="step2()" class="btn btn-primary">ถัดไป</button></div>
    </div>
    </div>
    <div class="row">
    <div class="col-12">
      <div class="col-sm-12">
      <button id="btnMsg" onclick="backStep1()" class="btn btn-danger">กลับ</button></div>
    </div></div>
  </div> 
 </div> </div>
 <br/>

</div>
<div id="step3" class="container">
  <h3 class="form-control" style="background-color: blueviolet;color: #fff;">สรุปการจองคิว</h3>
  <div class="row">
  <div class="col-sm-12">
    <label>ท่าเรือ</label>
    <input type="text" id="lblTerminal" class="form-control" readonly/>
  </div>    
</div> 
<div class="row">
      <div class="col-sm-12">
        <label>กิจกรรม</label>
        <input type="text" id="lblTopic" class="form-control" readonly/>
      </div>    
 </div> 
<div class="row">
  <div class="col-sm-12">
    <label>วันที่</label>
    <input type="text" id="lblDate" class="form-control" readonly/>
  </div>    
</div> 
<div class="row">
  <div class="col-sm-12">
    <label>เวลา</label>
    <input type="text" id="lblTime" class="form-control" readonly/>
  </div>    
</div> 
<div class="row">
    <div class="col-sm-12">
      <label>ทะเบียนรถ</label>
      <input type="text" id="txtLicense" class="form-control" maxlength="6"/>
    </div>
  </div> 
<br/>
<div class="row">
    <div class="col-sm-12">
      <label>เบอร์ติดต่อ</label>
      <input type="text" pattern="[0-9]*" inputmode="numeric" id="txtTelNo" class="form-control" maxlength="10"/>
    </div>
  </div> 
  <div class="row">
    <div class="col-sm-12">
      <label>หมายเลข บุ๊คกิ้ง</label>
      <input type="text" id="txtBKG" class="form-control" maxlength="50"/>
    </div>
  </div> 
<div class="row"  >
  <div class="col-sm-12">
    <button id="btnMsg" onclick="step3()" class="btn btn-primary">ส่งข้อมูล</button>
  </div></div>
  <div class="row">
  <div class="col-sm-12">
     
    <button id="btnMsg" onclick="backStep2()" class="btn btn-danger">กลับไป</button>
  </div>
</div> 
</div>
  <!-- <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>  -->
  <script src="https://static.line-scdn.net/liff/edge/versions/2.9.0/sdk.js"></script>
  <script>
    $(document).ready(function () {
          jQuery.extend(jQuery.mobile.datebox.prototype.options, {
              'dateFormat': 'dd/MM/YYYY',
              'headerFormat': 'dd/MM/YYYY',
          });
          $("#txtDate").click(function (event) {
              $(".ui-icon-calendar").trigger("click");
          });
          $("#txtTelNo").inputFilter(function(value) {
                return /^\d*$/.test(value);    // Allow digits only, using a RegExp
          },"กรอกตัวเลขเท่านั้น");
    });
       
    function step1() {
       var status=validData();
       console.log(status);
         if(status!=''){

         notie.alert({ type: 3, text: status, time: 2 })
          return;
         }
        var ddlToPic=$("#ddlToPic").val();
        var ddlTerminal=$("#ddlTerminal").val();
         
        var txtDate=$("#txtDate").val();
 
        console.log(ddlToPic+","+ddlTerminal+","+txtDate);
        $("#step1").hide();
        $("#step2").show();
        loadData();
    }
    async function  loadData (){
      $select = $('#checkboxes');
      var url='https://tq.sec443.com';
          //url='http://localhost:5081';
        $.ajax({
            type: "GET",
            url: url+'/Slottime/'+$("#ddlTerminal").val()+'/'+$("#txtDate").val().replaceAll('-','')+'/'+($("#ddlToPic").val()=='ส่งตู้(หนัก)'?'RE':'DI'),
            dataType: 'JSON',
            success:function(data) {
            console.log(JSON.stringify(data));
               var rowCount=0;
                $select.html('<table>');
                  console.log('check count==>'+data.list_slot.length);
                  if(data.list_slot.length==0){
                    $select.html('<div><h2 style="text-align:center">ไม่พบข้อมูล</h2><br/><div style="text-align: center;"><img src="images/nodata.png" width="100" /><div><div>');
                    $('.btnSaveStep2').hide();
                  }else{
                    $('.btnSaveStep2').show();
                      $.each(data.list_slot, function(key, val) {
                        if(parseInt(val.available)>0){
                          var slotText='';
                          var padData=padDigits(val.slot,2);
                          var slotText=padData+':00-'+padData+':59';
                          var style='';
                          var isDisible='';
                          var onClick='';
                          if(parseInt(val.available)==0){
                              style='buttonRed';
                              isDisible='disabled';
                              onClick='onclick="cannotSelect()"';
                          }
                        
                          $select.append('<tr><td><input type="radio" id='+slotText+' name="BookList" value='+slotText+' '+isDisible+' class="slot"></td><td> <label for='+slotText+' '+onClick+'> '+slotText+' </label></td><td> <label for='+slotText+' class="button  '+style+'" '+onClick+'> ว่าง : ' + val.available + ' สล็อต </label></td></tr>');
                          rowCount++;
                        }
                    });
                $select.append('</table>');

                
               }
               if(rowCount==0){
                  $select.html('<div><h2 style="text-align:center">คิววันนี้เต็มแล้ว</h2><br/><div style="text-align: center;"><img src="images/nodata.png" width="100" /><div><div>');
                  $('.btnSaveStep2').hide();
                }
            },
            error: function(){
              $select.html('<div><h2 style="text-align:center">ระบบขัดข้อง</h2><br/><div style="text-align: center;"><img src="images/nodata.png" width="100" /><div><div>');
            }
        });
    }
    function backStep1(){
      $("#step2").hide();
      $("#step1").show();
      //loadData();

    }
    function backStep2(){
      $("#step3").hide();
      $("#step2").show();
    }
    function step2() {
     
      $("#step2").hide();
      $("#step3").show();
      
      var ddlToPic=$("#ddlToPic").val();
        var ddlTerminal=$("#ddlTerminal").val();
        var txtLicense=$("#txtLicense").val();
        var txtDate=$("#txtDate").val();
        var txtTelNo=$("#txtTelNo").val();
        var txtTime=$('input[name="BookList"]:checked').val();
      console.log('result'+ddlToPic+","+ddlTerminal+","+txtLicense+","+txtDate+","+txtTelNo+","+txtTime);
      
        // document.getElementById("lblTopic").innerHTML = ddlToPic;
        // document.getElementById("lblTerminal").innerHTML =ddlTerminal;
        // document.getElementById("lblLicense").innerHTML = txtLicense;
        // document.getElementById("lblDate").innerHTML = txtDate;
        // document.getElementById("lblTime").innerHTML = txtDate;
        // document.getElementById("lblTel").innerHTML = txtTelNo;

        $("#lblTopic").val(ddlToPic) ;
        $("#lblTerminal").val(ddlTerminal);
        $("#lblLicense").val(txtLicense);
        $("#lblDate").val(txtDate);
        $("#lblTime").val(txtTime);
        $("#lblTel").val(txtTelNo);

    }
    function step3() {
       var status=validData2();
       console.log(status);
         if(status!=''){

         notie.alert({ type: 3, text: status, time: 2 })
          return;
         }
         notie.confirm({
          text: 'ยืนยันการบันทักข้อมูล?<br>',
          cancelCallback: function () {
            //notie.alert({ type: 3, text: 'Aw, why not? :(', time: 2 })
          },
          submitCallback: function () {
        
     
        var msg='จองคิว\n1.'+$("#ddlTerminal").val()+'\n2.'+$("#ddlToPic").val()+'\n3.'+$("#txtDate").val().replaceAll('-','')+'\n4.'+$("#lblTime").val()+'\n5.'+$("#txtLicense").val()+'\n6.'+$("#txtTelNo").val()+'\n7.'+$("#txtBKG").val();
        console.log(msg);
        sendMsg(msg);
        
          }
        })
       
     //alert('result'+ddlToPic+","+ddlTerminal+","+txtLicense+","+txtDate+","+txtTelNo);
 

   }
   function validData(){
        var status='';
         
    if($("#ddlToPic").val()=='--'){
      status+=',กิจกรรม ';
      
    }
    if($("#ddlTerminal").val()=='--'){
      status+=',ท่าเรือ ' ;
       
    }
    if($("#txtDate").val()==''){
      status+= ',วันที่ ';
       
    }
    if(status!=''){
        
      status='กรุณาเลือก '+status.substring(1,status.length-1);
      return status;
    }else{
    return '';}
   }
   function validData2(){
        var status='';
         
    if($("#txtTelNo").val()==''){
      status+=',เบอร์โทร ';
      
    }
    if($("#txtLicense").val()==''){
      status+=',ป้ายทะเบียน ' ;
       
    }
    if($("#txtBKG").val()==''){
      status+=',บุ๊คกิ้ง ' ;
       
    }
    if($("#txtTelNo").val().length!=10){
      status+=',เบอร์โทรให้ครบ ';
      
    }
    if($("#txtLicense").val().length!=6){
      status+=',ทะเบียนให้ครบ ';
      
    }
    if(status!=''){
        
      status='กรุณาเลือก '+status.substring(1,status.length-1);
      return status;
    }else{
    return '';}
   }
   function cannotSelect(){
    notie.alert({ type: 3, text: 'ไม่สามารถเลือกได้', time: 2 })
   }
   notie.setOptions({
        alertTime: 5
      })
   function error () {
        notie.alert({ type: 3, text: 'Error.', time: 2 })
      }

  function padDigits(number, digits) {
    return Array(Math.max(digits - String(number).length + 1, 0)).join(0) + number;
  }
    async function sendMsg(msg) {
      if (!liff.isInClient()) {
    window.alert('This button is unavailable as LIFF is currently being opened in an external browser.');
      } else {
          liff.sendMessages([
              {
                  type: 'text',
                  text: msg,
              },
          ]).then(() => {
                //success closeWindow
        if (!liff.isInClient()) {
          window.alert('This button is unavailable as LIFF is currently being opened in an external browser.');
        } else {
        //notie.alert({ type: 1, text: 'บันทีกสำเร็จ! :D', time: 2 });
        //setTimeout(() => {
          liff.closeWindow();
        //}, 2000);  
      }
        }).catch((error) => {

                  window.alert('Error sending message: ' + error);
        });
      }
    }

    

    async function getUserProfile() {
      liff.getProfile().then(profile => {
        document.getElementById("pictureUrl").src = profile.pictureUrl;
        document.getElementById("userId").innerHTML = '<b>UserId:</b> ' + profile.userId;
        document.getElementById("displayName").innerHTML = '<b>DisplayName:</b> ' + profile.displayName;
        document.getElementById("statusMessage").innerHTML = '<b>StatusMessage:</b> ' + profile.statusMessage;
        document.getElementById("getDecodedIDToken").innerHTML = '<b>Email:</b> ' + liff.getDecodedIDToken().email;
      }).catch(err => console.error(err));
      console.log(JSON.stringify(profile));
    }

    function getEnvironment() {
    }

     
    function runApp() {
      liff.getProfile().then(profile => {
        document.getElementById("pictureUrl").src = profile.pictureUrl;
        document.getElementById("userId").innerHTML = '<b>UserId:</b> ' + profile.userId;
        document.getElementById("displayName").innerHTML = '<b>สวัสดี:</b> ' + profile.displayName;
        document.getElementById("statusMessage").innerHTML = '<b>StatusMessage:</b> ' + profile.statusMessage;
        document.getElementById("getDecodedIDToken").innerHTML = '<b>Email:</b> ' + liff.getDecodedIDToken().email;
      }).catch(err => console.error(err));
    }
    $("#step2").hide();
    $("#step3").hide();
    liff.init({ liffId: "2000487303-op9O67xV" }, () => {
      if (liff.isLoggedIn()) {
        runApp()
      } else {
        liff.login();
      }
    }, err => console.error(err.code, error.message));
  </script>
</body>
</html>
